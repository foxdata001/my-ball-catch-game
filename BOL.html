<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Ball Catch Game for Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body {
      background: #222;
      margin: 0;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    canvas {
      background: #333;
      border-radius: 10px;
      width: 95vw;
      max-width: 600px;
      height: 60vh;
      max-height: 480px;
      display: block;
      margin: 10px 0;
    }
    button {
      padding: 12px 25px;
      font-size: 20px;
      background-color: orange;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      margin: 5px;
      user-select: none;
    }
    button:hover {
      background-color: #e07b00;
    }
    #instructions {
      max-width: 90vw;
      text-align: center;
      font-size: 18px;
      line-height: 1.4;
      margin-bottom: 15px;
      color: #ccc;
    }
    #leaderboard {
      background: #444;
      border-radius: 10px;
      padding: 15px 20px;
      width: 90vw;
      max-width: 350px;
      color: #eee;
      font-size: 18px;
      margin-top: 10px;
      text-align: left;
      display: none;
    }
    #leaderboard h3 {
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }
    #leaderboard ol {
      padding-left: 20px;
      margin: 0;
    }
    #leaderboard li {
      margin-bottom: 5px;
    }
    #feedbackMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      padding: 30px 50px;
      border-radius: 15px;
      font-size: 48px;
      font-weight: bold;
      color: #ffdd57;
      text-align: center;
      display: none;
      user-select: none;
      z-index: 10;
      box-shadow: 0 0 20px #ffdd57;
    }
  </style>
</head>
<body>

  <canvas id="game"></canvas>
  <button id="startBtn">เริ่มเกม</button>
  <button id="restartBtn" style="display:none;">เล่นใหม่</button>
  <div id="instructions">
    <strong>วิธีเล่น:</strong><br>
    • แตะและลากแท่งจับลูกบอลด้านล่างเพื่อเลื่อนไปซ้าย-ขวา<br>
    • พยายามจับลูกบอลไม่ให้ตกลงข้างล่าง ถ้าตกเกมจะจบและแสดงคะแนนของคุณ
  </div>

  <div id="leaderboard">
    <h3>ตารางอันดับคะแนนสูงสุด</h3>
    <ol id="scoreList"></ol>
  </div>

  <div id="feedbackMessage"></div>

  <!-- เพิ่ม audio tag สำหรับเพลงพื้นหลัง -->
  <audio id="bgMusic" src="background.mp3" loop></audio>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const instructions = document.getElementById('instructions');
    const leaderboard = document.getElementById('leaderboard');
    const scoreList = document.getElementById('scoreList');
    const feedbackMessage = document.getElementById('feedbackMessage');
    const bgMusic = document.getElementById('bgMusic');

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
    }
    window.addEventListener('resize', () => {
      resizeCanvas();
      resetPositions();
    });

    function resetPositions() {
      paddle.x = canvas.width / 2 - paddle.width / 2;
      ball.x = canvas.width / 2;
      ball.y = canvas.height / 2;
      ball.radius = Math.min(canvas.width, canvas.height) / 25;
      paddle.width = canvas.width / 5;
      paddle.height = canvas.height / 20;
      paddle.y = canvas.height - paddle.height - 20;
    }

    const paddle = {
      width: 100,
      height: 15,
      x: 0,
      y: 0,
      speed: 0,
      dx: 0
    };

    const ball = {
      x: 0,
      y: 0,
      radius: 15,
      speed: 1.5,
      dx: 1.5,
      dy: 1.5,
      color: 'cyan'
    };

    let score = 0;
    let gameStarted = false;

    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for(let i=0; i<6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function drawPaddle() {
      ctx.fillStyle = 'orange';
      ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
      ctx.fillStyle = ball.color;
      ctx.fill();
      ctx.closePath();
    }

    function drawScore() {
      ctx.font = '20px Arial';
      ctx.fillStyle = 'white';
      ctx.fillText('Score: ' + score, 10, 25);
    }

    function adjustSpeedByScore() {
      if(score >= 41) {
        ball.speed = 4.5;
      } else if(score >= 40) {
        ball.speed = 3.5;
      } else if(score >= 20) {
        ball.speed = 2.5;
      } else {
        ball.speed = 1.5;
      }

      ball.dx = (ball.dx > 0 ? 1 : -1) * ball.speed;
      ball.dy = (ball.dy > 0 ? 1 : -1) * ball.speed;
    }

    function moveBall() {
      ball.x += ball.dx;
      ball.y += ball.dy;

      if(ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) {
        ball.dx = -ball.dx;
      }

      if(ball.y - ball.radius < 0) {
        ball.dy = -ball.dy;
      }

      if(ball.dy > 0 &&
         ball.y + ball.radius >= paddle.y &&
         ball.y + ball.radius <= paddle.y + paddle.height &&
         ball.x >= paddle.x &&
         ball.x <= paddle.x + paddle.width) {
        ball.dy = -ball.dy;
        score++;
        ball.color = getRandomColor();

        adjustSpeedByScore();
      }

      if(ball.y - ball.radius > paddle.y + paddle.height) {
        gameOver();
      }
    }

    let isDragging = false;

    canvas.addEventListener('touchstart', function(e) {
      if(!gameStarted) return;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const touchX = touch.clientX - rect.left;

      if(touchX >= paddle.x && touchX <= paddle.x + paddle.width &&
         (e.touches[0].clientY - rect.top) >= paddle.y) {
        isDragging = true;
      }
      e.preventDefault();
    }, {passive: false});

    canvas.addEventListener('touchmove', function(e) {
      if(!gameStarted || !isDragging) return;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      let newX = touch.clientX - rect.left - paddle.width / 2;

      if(newX < 0) newX = 0;
      if(newX + paddle.width > canvas.width) newX = canvas.width - paddle.width;

      paddle.x = newX;
      e.preventDefault();
    }, {passive: false});

    canvas.addEventListener('touchend', function(e) {
      isDragging = false;
      e.preventDefault();
    }, {passive: false});

    function keyDownHandler(e) {
      if(!gameStarted) return;

      if(e.key === "ArrowRight") {
        paddle.dx = 7;
      }
      else if(e.key === "ArrowLeft") {
        paddle.dx = -7;
      }
    }

    function keyUpHandler(e) {
      if(!gameStarted) return;

      if(e.key === "ArrowRight" || e.key === "ArrowLeft") {
        paddle.dx = 0;
      }
    }

    function movePaddle() {
      paddle.x += paddle.dx;
      if (paddle.x < 0) paddle.x = 0;
      if (paddle.x + paddle.width > canvas.width) paddle.x = canvas.width - paddle.width;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      drawPaddle();
      drawBall();
      drawScore();

      if(gameStarted) {
        movePaddle();
        moveBall();
      }

      requestAnimationFrame(draw);
    }

    function updateLeaderboard(newScore) {
      let leaderboardData = JSON.parse(localStorage.getItem('ballCatchLeaderboard')) || [];

      leaderboardData.push(newScore);
      leaderboardData.sort((a, b) => b - a);
      leaderboardData = leaderboardData.slice(0, 5);

      localStorage.setItem('ballCatchLeaderboard', JSON.stringify(leaderboardData));

      return leaderboardData;
    }

    function showLeaderboard() {
      const data = JSON.parse(localStorage.getItem('ballCatchLeaderboard')) || [];
      scoreList.innerHTML = '';

      if(data.length === 0) {
        scoreList.innerHTML = '<li>ยังไม่มีคะแนน</li>';
      } else {
        data.forEach((score, index) => {
          scoreList.innerHTML += `<li>${index + 1}. ${score} คะแนน</li>`;
        });
      }

      leaderboard.style.display = 'block';
    }

    function getFeedbackMessage(score) {
      if(score >= 0 && score <= 20) {
        return 'กาก';
      } else if(score >= 21 && score <= 40) {
        return 'เก่ง';
      } else if(score >= 41) {
        return 'เก่งมาก';
      }
      return '';
    }

    function gameOver() {
      gameStarted = false;
      restartBtn.style.display = 'inline-block';

      bgMusic.pause();
      bgMusic.currentTime = 0;

      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance('เกมโอเวอร์');
        utterance.lang = 'th-TH';
        window.speechSynthesis.speak(utterance);
      }

      const updatedLeaderboard = updateLeaderboard(score);
      const feedback = getFeedbackMessage(score);

      feedbackMessage.textContent = `คุณ: ${feedback}`;
      feedbackMessage.style.display = 'block';

      showLeaderboard();
    }

    function startGame() {
      score = 0;
      ball.speed = 1.5;
      ball.dx = ball.speed;
      ball.dy = ball.speed;
      ball.color = 'cyan';
      resetPositions();
      gameStarted = true;
      restartBtn.style.display = 'none';
      startBtn.style.display = 'none';
      instructions.style.display = 'none';
      leaderboard.style.display = 'none';
      feedbackMessage.style.display = 'none';
      paddle.dx = 0;

      bgMusic.currentTime = 0;
      bgMusic.play().catch(e => {
        console.log('เพลงไม่เล่นอัตโนมัติ:', e);
      });
    }

    startBtn.addEventListener('click', () => {
      resizeCanvas();
      startGame();
    });

    restartBtn.addEventListener('click', () => {
      resizeCanvas();
      startGame();
    });

    document.addEventListener('keydown', keyDownHandler);
    document.addEventListener('keyup', keyUpHandler);

    resizeCanvas();
    resetPositions();
    draw();
  </script>

</body>
</html>
